---
- name: Create folder to store data
  ansible.builtin.file:
    path: "{{ ansible_env['HOME'] }}/docker/postgres/{{ item }}"
    state: directory
  loop:
    - data

- name: Run the Postgres docker container
  community.docker.docker_container:
    name: postgres
    image: "pgvector/pgvector:{{ postgres_version }}"
    state: started
    restart_policy: always
    volumes:
      - "{{ ansible_env['HOME'] }}/docker/postgres/data:/var/lib/postgresql"
    env:
      POSTGRES_PASSWORD: "{{ postgres_password }}"

    networks:
      - name: "{{ docker_network_name }}"
    ports:
      - "5432:5432"
- name: Install required python module
  ansible.builtin.pip:
    name: psycopg[binary]>=3.1.8
    extra_args: --break-system-packages

# Create required users and credentials
- name: Create databases users
  community.postgresql.postgresql_user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    login_host: 127.0.0.1
    login_user: postgres
    login_password: "{{ postgres_password }}"
  loop: "{{ postgres_users }}"

# Create required databases
- name: Create databases
  community.postgresql.postgresql_db:
    name: "{{ item.name }}"
    owner: "{{ item.owner }}"
    comment: "{{ item.comment }}"
    encoding: "{{ item.encoding }}"
    login_host: 127.0.0.1
    login_user: postgres
    login_password: "{{ postgres_password }}"
  loop: "{{ postgres_databases }}"

# Enable extensions
- name: Ensure specific extensions are enabled
  community.postgresql.postgresql_ext:
    login_db: "{{ item.0.name }}"
    name: "{{ item.1 }}"
    login_user: postgres
    login_password: "{{ postgres_password }}"
    login_host: "127.0.0.1"
    state: present
  loop: "{{ postgres_databases | subelements('extensions', skip_missing=True) }}"
